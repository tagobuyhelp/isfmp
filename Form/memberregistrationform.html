<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INL Member Registration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100 font-roboto">
    <div class="container mx-auto p-1">
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0  items-center justify-center bg-gray-800 bg-opacity-50 hidden">
            <div class="flex flex-col items-center">
                <i class="fas fa-spinner fa-spin text-white text-4xl"></i>
                <p class="text-white mt-2">Please wait, processing your request...</p>
            </div>
        </div>

        <!-- Step 1: Check Member Status -->
        <div id="check-member-status" class="bg-white p-6 rounded shadow-md mb-6">
            <form id="member-status-form" class="space-y-4">
                <div>
                    <label for="aadhaar" class="block text-sm font-medium text-gray-700">Aadhaar</label>
                    <input type="text" id="aadhaar" name="aadhaar"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required maxlength="12">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="text" id="phone" name="phone"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required maxlength="10">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white p-2 rounded-md">Next</button>
            </form>
        </div>

        <!--Verify OTP-->
        <div id="verify-otp" class="bg-white p-6 rounded shadow-md mb-6 hidden">
            <form id="verify-otp-form" class="space-y-4">
                <label for="otp" class="block text-sm font-medium text-gray-700">Enter OTP</label>
                <input type="text" id="otp" name="otp" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                    required maxlength="6">
                <button type="submit" class="w-full bg-red-600 text-white p-2 rounded-md">Verify OTP</button>
            </form>
        </div>

        <!-- Step 2: New Member Registration -->
        <div id="new-member-registration" class="bg-white p-6 rounded shadow-md mb-6  hidden">
            <h2 class="text-2xl font-bold mb-4">New Member Registration</h2>
            <form id="registration-form" class="space-y-4">
                <div>
                    <label for="fullname" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullname" name="fullname"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>

                </div>
                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                    <input type="date" id="dob" name="dob"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                    <textarea id="address" name="address"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required></textarea>
                </div>
                <div>
                    <label for="state">State</label>
                    <select name="state" id="state" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Select State</option>
                    </select>
                </div>
                <div>
                    <label for="district">District</label>
                    <select name="district" id="district"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Select District</option>
                    </select>
                </div>
                <div>
                    <label for="parliamentConstituency" class="block text-sm font-medium text-gray-700">Parliament Constituency</label>
                    <input type="text" id="parliamentConstituency" name="parliamentConstituency"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="assembly-constituency" class="block text-sm font-medium text-gray-700">Assembly
                        Constituency</label>
                    <input type="text" id="assembly-constituency" name="assemblyConstituency"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="panchayat" class="block text-sm font-medium text-gray-700">Panchayat</label>
                    <input type="text" id="panchayat" name="panchayat"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="pincode" class="block text-sm font-medium text-gray-700">Pin Code</label>
                    <input type="text" id="pincode" name="pinCode"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" maxlength="6" required>
                </div>
                <div>
                    <label for="photo" class="block text-sm font-medium text-gray-700">Upload Photo</label>
                    <input type="file" id="photo" name="photo"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md" accept="image/*" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Membership Type</label>
                    <div class="mt-1">
                        <select name="membershipType" id="membershipType">
                            <option value="general">General Membership (₹20)</option>
                            <option value="active">Active Membership (₹100)</option>
                        </select>
                    </div>
                </div>
                <div id="declaration-div" class="hidden">
                    <input type="checkbox" name="declaration" id="declaration">
                    <label for="declaration">I am ready to work any time as per the requirement of
                        the organisation.</label>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white p-2 rounded-md">Register</button>
            </form>
        </div>


        <!-- Step 3: Membership Validation -->
        <div id="membership-validation" class="bg-white p-6 rounded shadow-md mb-6 hidden">
            <h2 class="text-2xl font-bold mb-4">Membership Validation</h2>
            <p class="mb-4">Your membership has been successfully validated. Please download your ID card below.</p>
            <a href="#" id="id-card-download-link"
                class="w-full bg-blue-500 text-white p-2 rounded-md text-center block">Download ID Card</a>
        </div>

        <div id="membership-fee" class="bg-white p-6 rounded shadow-md mb-6 hidden">
            <h2 class="text-2xl font-bold mb-4">Pay your Membership Fees</h2>
            <button type="submit" class="w-full bg-red-600 text-white p-2 rounded-md" id="pay-now">Pay Now</button>
        </div>
    </div>

    <script>
        const API_HOST_URL = 'http://localhost:4444';
        const VERIFY_MEMBER = '/member/verify';
        const VERIFY_OTP = '/member/verify-otp';
        const REGISTER_MEMBER = '/member/register';
        const CHECK_MEMBERSHIP = '/member/check-membership';
        const MEMBER = '/member/member-by-email-phone';
        const CREATE_MEMBERSHIP = '/membership';
        const api = (p) => new URL(p, API_HOST_URL).toString();

        const msg91Config = {
            widgetId: "356c6c6c3268333035333436",
            tokenAuth: "482671TDqWReFI7J693c10c7P1",
            exposeMethods: true,
            success: function () {},
            failure: function () {}
        };
        (function(){
            const s=document.createElement('script');
            s.src="https://verify.msg91.com/otp-provider.js";
            s.async=true;
            s.onload=function(){ if (typeof window.initSendOTP==='function') { window.initSendOTP(msg91Config); } };
            document.head.appendChild(s);
        })();


        document.addEventListener("DOMContentLoaded", function () {
            const membershipTypeSelect = document.getElementById("membershipType");
            const declarationDiv = document.getElementById("declaration-div");

            // Add an event listener for change event on the select element
            membershipTypeSelect.addEventListener("change", function () {
                if (this.value === "active") {
                    declarationDiv.classList.remove("hidden");
                } else {
                    declarationDiv.classList.add("hidden");
                }
            });
        });

        // JavaScript to handle form submissions and API interactions
        document.getElementById('member-status-form').addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const aadhaar = formData.get('aadhaar');
            const email = formData.get('email');
            const phone = formData.get('phone');




            if (aadhaar && email && phone) { // Optional validation
                localStorage.setItem('aadhaar', aadhaar);
                localStorage.setItem('email', email);
                localStorage.setItem('phone', phone);
                console.log('Data saved to localStorage');
            } else {
                console.error('Missing form fields');
            }

            // Show loading spinner
            document.getElementById('loading-spinner').classList.remove('hidden');
            fetch(api(VERIFY_MEMBER), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ aadhaar, phone, email })
            })
                .then(response => response.json())
                .then(data => {
                    // Hide loading spinner
                    document.getElementById('loading-spinner').classList.add('hidden');

                    if (data.statusCode === 200) {
                        // Alert message from the server
                        window.alert(data.data.toString());

                        // Show OTP verification form
                        document.getElementById('verify-otp').classList.remove('hidden');
                        if (window.sendOtp) { window.sendOtp('91'+phone); }
                        document.getElementById('verify-otp-form').addEventListener('submit', async function (event) {
                            event.preventDefault();
                            const otp = document.getElementById('otp').value;
                            document.getElementById('loading-spinner').classList.remove('hidden');
                            try {
                                const token = await new Promise((resolve, reject) => {
                                    if (window.verifyOtp) {
                                        window.verifyOtp(otp, function (vData) {
                                            resolve(vData && (vData.accessToken || vData.token));
                                        }, function (err) {
                                            reject(err);
                                        });
                                    } else {
                                        reject(new Error('OTP widget not loaded'));
                                    }
                                });

                                const resp = await fetch(api('/otp/msg91/verify-token'), {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ accessToken: token })
                                });
                                const data = await resp.json();
                                document.getElementById('loading-spinner').classList.add('hidden');

                                if (data.success === true) {
                                    window.alert('OTP Verified!');
                                    const checkResp = await fetch(api(CHECK_MEMBERSHIP), {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ email, phone })
                                    });
                                    const checkData = await checkResp.json();
                                    if (checkData && checkData.success === true) {
                                        document.getElementById('verify-otp').classList.add('hidden');
                                        document.getElementById('check-member-status').classList.add('hidden');
                                        document.getElementById('membership-validation').classList.remove('hidden');
                                        document.getElementById('id-card-download-link').href = checkData.updatedMember.idCard;
                                        document.querySelector('#verify-otp-form button[type="submit"]').disabled = true;
                                    } else {
                                        window.alert('You have not completed the payment - Pay your Membership Fees!');
                                        document.getElementById('check-member-status').classList.add('hidden');
                                        document.getElementById('verify-otp').classList.add('hidden');
                                        document.getElementById('membership-fee').classList.remove('hidden');
                                        let fee = 0;
                                        let validity = 3;
                                        document.getElementById('pay-now').addEventListener('click', async function () {
                                            try {
                                                const memberResp = await fetch(api(MEMBER), {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ email, phone })
                                                });
                                                const memberData = await memberResp.json();
                                                if (memberData.statusCode === 200) {
                                                    fee = memberData.message.membershipType === 'general' ? 20 : 100;
                                                    const payResp = await fetch(api(CREATE_MEMBERSHIP), {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ amount: fee, validity, email, mobileNumber: phone, type: memberData.message.membershipType })
                                                    });
                                                    const payData = await payResp.json();
                                                    if (payData && payData.paymentLink) {
                                                        window.location.href = payData.paymentLink;
                                                    } else {
                                                        alert('Failed to retrieve payment link. Please try again later.');
                                                    }
                                                }
                                            } catch (error) {
                                                console.error('Error occurred while creating membership:', error);
                                                alert('An error occurred. Please try again later.');
                                            }
                                        });
                                    }
                                } else {
                                    window.alert('Invalid OTP. Please try again.');
                                }
                            } catch (error) {
                                document.getElementById('loading-spinner').classList.add('hidden');
                                console.error('Error:', error);
                                window.alert('OTP verification failed');
                            }
                        });
                    } else {
                        document.getElementById('check-member-status').classList.add('hidden');
                        document.getElementById('new-member-registration').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    // Hide loading spinner
                    document.getElementById('loading-spinner').classList.add('hidden');
                    console.error('Error:', error)
                });
        });

// Handle Hierarchical Location Selections
document.addEventListener('DOMContentLoaded', function () {
    const stateSelect = document.getElementById('state');
    const districtSelect = document.getElementById('district');
    // Remove the constituencySelect variable as it's no longer a dropdown

    const COUNTRY_ID = '677a5d381b1d49ca155e6e1d';

    // Fetch and populate states for the pre-selected country
    fetchLocations('states', stateSelect, COUNTRY_ID);

    // Handle state selection
    stateSelect.addEventListener('change', function () {
        const selectedStateId = this.value;
        const selectedStateName = this.options[this.selectedIndex].textContent;

        this.setAttribute('data-selected-name', selectedStateName);

        districtSelect.innerHTML = '<option value="">Select District</option>';
        // Remove the line that clears the constituency as it's now a text input

        if (selectedStateId) {
            fetchLocations('districts', districtSelect, selectedStateId);
        }
    });

    // Handle district selection
    districtSelect.addEventListener('change', function () {
        const selectedDistrictId = this.value;
        const selectedDistrictName = this.options[this.selectedIndex].textContent;

        this.setAttribute('data-selected-name', selectedDistrictName);

        // Remove the lines that fetch and populate constituencies
    });

    // Generic function to fetch and populate location dropdowns
    function fetchLocations(locationType, selectElement, parentId) {
        const url = api(`/${locationType}/${parentId}`);

        document.getElementById('loading-spinner').classList.remove('hidden');

        fetch(url, { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-spinner').classList.add('hidden');

                if (data.success && Array.isArray(data.data)) {
                    data.data.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location._id;
                        option.textContent = location.name;
                        selectElement.appendChild(option);
                    });
                } else {
                    console.error(`Failed to retrieve ${locationType}:`, data.message || 'Unexpected data format');
                    alert(`Failed to load ${locationType}. Please try again.`);
                }
            })
            .catch(error => {
                document.getElementById('loading-spinner').classList.add('hidden');
                console.error(`Error fetching ${locationType}:`, error);
                alert(`An error occurred while loading ${locationType}. Please try again.`);
            });
    }
});
document.getElementById('registration-form').addEventListener('submit', function (event) {
    event.preventDefault();

    const formData = new FormData(event.target);

    // Set the country name (since it's fixed)
    formData.set('country', 'India'); // Assuming the country name is India

    // Replace IDs with names for state and district
    const stateSelect = document.getElementById('state');
    const districtSelect = document.getElementById('district');

    // Set state name
    formData.set('state', stateSelect.options[stateSelect.selectedIndex].textContent);

    // Set district name
    formData.set('district', districtSelect.options[districtSelect.selectedIndex].textContent);

    // Get the manually entered Parliament Constituency
    const parliamentConstituency = document.getElementById('parliamentConstituency').value;
    formData.set('parliamentConstituency', parliamentConstituency);

    // Add aadhaar, email, and phone from localStorage
    const aadhaar = localStorage.getItem('aadhaar');
    const email = localStorage.getItem('email');
    const phone = localStorage.getItem('phone');

    if (aadhaar) formData.append('aadhaar', aadhaar);
    if (email) formData.append('email', email);
    if (phone) formData.append('phone', phone);

    console.log(...formData); // For debugging

    // Show loading spinner
    document.getElementById('loading-spinner').classList.remove('hidden');

    // Submit the form data
    fetch(api(REGISTER_MEMBER), {
        method: 'POST',
        body: formData,
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Hide loading spinner
            document.getElementById('loading-spinner').classList.add('hidden');
            console.log('API Response:', data); // Log API response for debugging

            if (data.statusCode === 201) {
                document.getElementById('new-member-registration').classList.add('hidden');
                // Success handling
                window.alert(data.data || "We've Received Your Application – Complete Your Membership Payment");

                //Next - Show the Pay Now button - Call the Create Membership Api
                document.getElementById('membership-fee').classList.remove('hidden');


                        let fee = 0;
                        let validity = 3;
                        document.getElementById('pay-now').addEventListener('click', function () {
                            //First find the already seleced membership type

                            // Show loading spinner
                            document.getElementById('loading-spinner').classList.remove('hidden');
                            fetch(api(MEMBER), {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ email, phone })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    // Hide loading spinner
                                    document.getElementById('loading-spinner').classList.add('hidden');
                                    if (data.statusCode === 200) {
                                        if (data.message.membershipType === 'general') {
                                            fee = 20;
                                        } else if (data.message.membershipType === 'active') {
                                            fee = 100;
                                        }


                                        //Lest Call Create Membership API - Get Payment URL & Redirect Payment Page
                                        // Show loading spinner
                                        document.getElementById('loading-spinner').classList.remove('hidden');
                                        fetch(api(CREATE_MEMBERSHIP), {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({
                                                amount: fee,
                                                validity,
                                                email,
                                                mobileNumber: phone,
                                                type: data.message.membershipType
                                            })
                                        })
                                            .then(response => response.json())
                                            .then(data => {
                                                // Hide loading spinner
                                                document.getElementById('loading-spinner').classList.add('hidden');

                                                if (data && data.paymentLink) {
                                                    // Redirect to the payment page
                                                    window.location.href = data.paymentLink;
                                                } else {
                                                    console.error('Payment link not received from the server.');
                                                    alert('Failed to retrieve payment link. Please try again later.');
                                                }
                                            })
                                            .catch(error => {
                                                // Hide loading spinner
                                                document.getElementById('loading-spinner').classList.add('hidden');

                                                console.error('Error occurred while creating membership:', error);
                                                alert('An error occurred. Please try again later.');
                                            });


                                    }
                                })
                                .catch(error => {
                                    // Hide loading spinner
                                    document.getElementById('loading-spinner').classList.add('hidden');
                                    console.error(error)
                                })


                        })
                    } else {
                        // Handle API error response
                        console.error('API Error:', data);
                        window.alert(data.message || 'An error occurred. Please try again.');
                    }
                })
                .catch(error => {
                    // Hide loading spinner
                    document.getElementById('loading-spinner').classList.add('hidden');
                    console.error('Error:', error);
                    window.alert('Something went wrong. Please try again later.');
                });
        });

        // Add this function to your script
function safelyAccessChildWindow(callback) {
  if (window.opener && !window.opener.closed) {
    callback(window.opener);
  } else {
    console.log('Child window is not available');
  }
}

// Use it like this
safelyAccessChildWindow(function(childWindow) {
  // Your code to interact with the child window
});
    </script>
</body>

</html>
