<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTP Test</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#f7fafc;margin:0;padding:2rem}
    .card{max-width:420px;margin:0 auto;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:1rem}
    .row{margin-bottom:0.75rem}
    label{display:block;font-size:0.9rem;color:#374151;margin-bottom:0.25rem}
    input{width:100%;padding:0.5rem;border:1px solid #cbd5e1;border-radius:6px}
    button{width:100%;padding:0.6rem;border:0;border-radius:6px;background:#2563eb;color:#fff;cursor:pointer}
    button.secondary{background:#6b7280}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem}
    .status{margin-top:0.75rem;font-size:0.9rem;color:#111827}
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <label>Phone (with country code, e.g. 9197XXXXXXXX)</label>
      <input id="phone" type="tel" placeholder="9197XXXXXXXX" value="91" />
    </div>
    <div class="grid">
      <button id="send">Send OTP</button>
      <button id="retry" class="secondary">Resend</button>
    </div>
    <div class="row">
      <label>Enter OTP</label>
      <input id="otp" type="text" maxlength="6" />
    </div>
    <button id="verify">Verify OTP</button>
    <div id="status" class="status"></div>
  </div>

  <script>
    const API_HOST_URL = 'http://localhost:4444';
    const api = (p) => new URL(p, API_HOST_URL).toString();
    const configuration = {
      widgetId: "356c6c6c3268333035333436",
      tokenAuth: "482671TDqWReFI7J693c10c7P1",
      exposeMethods: true,
      success: function () {},
      failure: function () {}
    };

    (function loadOtpScript(urls){
      let i=0;function attempt(){
        const s=document.createElement('script');
        s.src=urls[i];s.async=true;
        s.onload=function(){ if(typeof window.initSendOTP==='function'){ console.log('Widget script loaded:', s.src); window.initSendOTP(configuration); } };
        s.onerror=function(){ i++; if(i<urls.length) attempt(); };
        document.head.appendChild(s);
      } attempt();
    })([
      "https://verify.msg91.com/otp-provider.js",
      "https://verify.phone91.com/otp-provider.js"
    ]);

    const statusEl=document.getElementById('status');
    const phoneEl=document.getElementById('phone');
    const otpEl=document.getElementById('otp');

    document.getElementById('send').addEventListener('click',function(){
      let ph=phoneEl.value.trim();
      if(!ph){ statusEl.textContent='Enter phone'; return; }
      if(!ph.startsWith('91')){ ph = '91' + ph; }
      console.log('Sending OTP to:', ph);
      if(window.sendOtp){
        window.sendOtp(ph, function(){ console.log('OTP send success'); statusEl.textContent='OTP sent'; }, function(e){ console.log('OTP send error', e); statusEl.textContent='Send failed'; });
      } else { statusEl.textContent='Widget not loaded'; }
    });

    document.getElementById('retry').addEventListener('click',function(){
      if(window.retryOtp){
        console.log('Retrying OTP');
        window.retryOtp(null, function(){ console.log('Retry success'); statusEl.textContent='OTP resent'; }, function(e){ console.log('Retry error', e); statusEl.textContent='Resend failed'; });
      } else { statusEl.textContent='Widget not loaded'; }
    });

    document.getElementById('verify').addEventListener('click',async function(){
      const code=otpEl.value.trim();
      if(!code){ statusEl.textContent='Enter OTP'; return; }
      if(!window.verifyOtp){ statusEl.textContent='Widget not loaded'; return; }
      statusEl.textContent='Verifying...';
      console.log('Verifying OTP:', code);
      try{
        const token=await new Promise((resolve,reject)=>{
          window.verifyOtp(code, function(d){ console.log('Widget verify success', d); resolve(d && (d.accessToken||d.token||d.message)); }, function(err){ console.log('Widget verify error', err); reject(err); });
        });
        console.log('Access token:', token);
        const resp=await fetch(api('/otp/msg91/verify-token'),{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ accessToken: token }) });
        let data=null;
        try { data=await resp.json(); } catch(e) { console.log('JSON parse error', e); }
        console.log('Server verify status:', resp.status, 'response:', data);
        if (resp.ok && data && data.success) {
          statusEl.textContent = 'Verified';
          document.getElementById('verify').disabled = true;
        } else {
          statusEl.textContent = 'Invalid';
        }
      }catch(e){ console.log('Verify failed', e); statusEl.textContent='Verify failed'; }
    });
  </script>
</body>
</html>
